# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Purpose

This repository generates a single, monolithic EC2 user-data provisioning script (`dist/ec2-userdata.sh`) from modular sources. The script provisions an Ubuntu EC2 instance with a Laravel/Inertia/React + PostgreSQL stack.

## Build Command

```bash
bin/build-userdata
```

This concatenates `config/`, `modules/`, and base64-encoded `templates/` into `dist/ec2-userdata.sh`. Always rebuild after modifying sources.

## Validation

```bash
bash -n dist/ec2-userdata.sh
```

Syntax-check the generated script before deploying.

## Architecture

### Module System
Modules in `modules/` define setup phases using `register_step <function_name>`. The build script includes them in sorted order (00, 10, 20, ..., 999), and the final script executes registered functions sequentially via `run_registered_steps`.

- **00-system-prep.sh**: APT updates, base packages (curl, git, build tools, fail2ban, ufw)
- **10-system-config.sh**: Swap, timezone, hostname, sysctl tuning
- **20-security.sh**: SSH hardening, UFW rules, fail2ban config
- **30-nginx.sh**: Nginx installation and Laravel-optimized config
- **40-php.sh**: PHP-FPM (version from `PHP_VERSION`), Composer, common extensions
- **50-helper-scripts.sh**: Installs executables from `templates/usr-local-bin/` and creates bash aliases
- **60-node.sh**: NVM + Node.js (version from `NODE_VERSION`), pnpm
- **70-cli-tools.sh**: AWS CLI, GitHub CLI
- **75-git.sh**: Git config, SSH key generation
- **80-ssl.sh**: Installs `setup-ssl` helper for Let's Encrypt
- **85-database.sh**: PostgreSQL, Redis, Adminer, Mailpit
- **90-services.sh**: Enables/starts systemd units (nginx, php-fpm, postgresql, redis)
- **95-claude.sh**: Claude Code config (agents, hooks)
- **98-laravel-auto-setup.sh**: Conditionally runs `setup-laravel` if `LARAVEL_AUTO_SETUP=true`
- **99-summary.sh**: Final instructions and next steps
- **999-finalize.sh**: Cleanup tasks

### Configuration
- **config/variables.sh**: Default versions (`PHP_VERSION=8.4`, `NODE_VERSION=22`, `POSTGRES_VERSION=17`), S3 paths, swap size
- **config/helpers.sh**: Utility functions:
  - `register_step <fn>`: Adds function to execution queue
  - `log_section <msg>`: Prints section headers
  - `install_template <key> <dest> [mode]`: Decodes base64 payload and writes file
  - `install_executable <key> <dest>`: Shortcut for 0755 mode
  - `append_if_missing <line> <file>`: Idempotent line append
  - `payload_b64 <key>`: Returns base64-encoded template (generated by build script)

### Templates
Files in `templates/` are base64-encoded into the `payload_b64` case statement during build. Runtime code calls `install_template "etc/nginx/sites-available/default" "/etc/nginx/sites-available/default"` to decode and write.

Structure:
- `templates/etc/`: System config files (nginx, profile.d scripts, sudoers)
- `templates/usr-local-bin/`: Helper scripts (deploy, fresh, artisan, backup-database, setup-laravel, setup-ssl, gkey, server-help, server-info, etc.)
- `templates/var/`: App skeletons and service configs

Helper scripts provide Laravel workflow commands. Examples: `deploy` (full build), `fresh` (reset DB + seed), `vdev` (Vite HMR), `laravel-fix-perms` (ACL for www-data).

## Development Workflow

1. Edit module in `modules/` or add/modify files in `templates/`
2. Run `bin/build-userdata` to regenerate `dist/ec2-userdata.sh`
3. Syntax-check with `bash -n dist/ec2-userdata.sh`
4. Test on disposable EC2 instance; review `/var/log/userdata.log`

## Important Notes

- **Never run** the provisioning script locally; it's designed for Ubuntu EC2 with root
- Commit changes to `modules/` and `templates/`, not the generated `dist/ec2-userdata.sh`
- When bumping versions in `config/variables.sh`, update any S3 artifacts referenced in `aws-ec2-user-data-downloader.sh`
- Helper scripts in `templates/usr-local-bin/` should be self-contained for independent testing